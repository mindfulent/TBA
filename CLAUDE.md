# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

TBA (TheBlock.Academy) is a Fabric 1.21.1 modpack for a community Minecraft server, built with [Packwiz](https://packwiz.infra.link/) for version control and distribution. The server runs on Bloom.host using mrpack4server for automatic modpack deployment from GitHub releases.

## Common Commands

```bash
# Add a mod (CurseForge preferred for compliance)
./packwiz.exe cf install <mod-slug> -y    # CurseForge (preferred)
./packwiz.exe mr install <mod-slug> -y    # Modrinth (fallback only)

# Update mods
./packwiz.exe update --all                # Update all mods
./packwiz.exe update <name>               # Update specific mod

# Export for distribution
./packwiz.exe modrinth export             # Creates .mrpack for Prism/server
./packwiz.exe curseforge export           # Creates .zip for CurseForge App

# Server management (requires .env with credentials)
python server-config.py                   # Interactive menu
python server-config.py status            # Check server status
python server-config.py update-pack <ver> # Update LocalServer (default)
python server-config.py update-pack <ver> -p  # Update production
python server-config.py restart           # Restart server
python server-config.py cmd "say Hello"   # Send console command
python server-config.py backup list       # List backups
```

## Deployment Workflow

**CRITICAL: Always test locally before deploying to production.**

```bash
# 1. Make changes (add/update/remove mods)
./packwiz.exe cf install <mod-slug> -y

# 2. Bump version in pack.toml

# 3. Export
./packwiz.exe modrinth export

# 4. Commit and push
git add -A && git commit -m "vX.Y.Z - description" && git push

# 5. Create GitHub release
gh release create vX.Y.Z TBA-X.Y.Z.mrpack --title "vX.Y.Z"

# 6. Update server (LocalServer first, then production)
python server-config.py update-pack X.Y.Z       # LocalServer
python server-config.py update-pack X.Y.Z -p    # Production

# 7. Restart server
python server-config.py restart
```

**⚠️ Never skip `update-pack`** - the server will fail without the updated hash in `modpack-info.json`.

## Architecture

```
Local Dev (packwiz) → GitHub Release (.mrpack) → Bloom.host (mrpack4server)
```

**Key files:**
- `pack.toml` - Pack metadata (name, version, MC version, Fabric version)
- `index.toml` - File index with hashes (auto-generated by packwiz)
- `modpack-info.json` - Server config pointing to GitHub release URL with SHA512 hash
- `mods/*.pw.toml` - Mod metadata files (managed by packwiz)
- `server-config.py` - Server management script (SFTP + Pterodactyl API)

**Server deployment:**
- mrpack4server reads `modpack-info.json` for release URL and hash
- Downloads .mrpack from GitHub, validates hash, extracts mods
- `non_overwritable_paths` protects world data and server config

## CurseForge-First Policy

**Always try CurseForge first** for mod distribution compliance:

1. Use `./packwiz.exe cf install <mod>` first
2. If wrong file returned (e.g., Spigot instead of Fabric), check CurseForge project page for correct file ID
3. Only use Modrinth (`mr install`) if mod doesn't exist on CurseForge
4. Document Modrinth-only mods in CHANGELOG (they become overrides in CF export)

## Shaderpacks

**⚠️ CRITICAL: Always commit shader files to git immediately after adding them.**

Packwiz exports include all files in the `shaderpacks/` directory regardless of git status. If shader files exist locally but aren't committed:
- They'll be included in exports while on that machine
- They'll be lost when the working directory is cleaned/rebuilt
- Other contributors won't have them

**When adding shaders:**
1. Download/copy shader to `shaderpacks/` directory
2. Run `./packwiz.exe refresh` to update index.toml
3. `git add shaderpacks/<shader>.zip` immediately
4. Commit with the release

**Current bundled shaders (all must be in git):**
- BSL v10.0
- Complementary Reimagined r5.6.1
- Photon v1.2a
- Solas Shader v3.1c

## Files to Update When Releasing

| File | Update |
|------|--------|
| `pack.toml` | Version number |
| `CHANGELOG.md` | Version entry with changes and mod count |
| `README.md` | Version in title, mod list if changed |
| `docs/CREDITS.md` | New mod entries with donate links |

## Credentials

Required in `.env` (see `.env.example`):
- `SFTP_HOST`, `SFTP_PORT`, `SFTP_USERNAME`, `SFTP_PASSWORD` - Bloom.host SFTP
- `PTERODACTYL_API_KEY`, `PTERODACTYL_SERVER_ID` - Bloom.host panel API

## Mod Distribution

Two export formats for different purposes:

| Format | Created By | For | Notes |
|--------|------------|-----|-------|
| `.mrpack` | `modrinth export` | Prism Launcher + Server | Full modpack including server-only mods |
| `.zip` | `curseforge export` | CurseForge App | Excludes Modrinth-only mods |

**Server-only mods** (in mrpack, not needed by clients): AutoWhitelist, Better Sleep, Fabricord, Ledger, Advanced Backups, LuckPerms

## Requirements

- Minecraft 1.21.1
- Fabric 0.18.3+
- Java 21 (required for MC 1.20.5+)
- Python 3.x with `paramiko`, `rich` (for server-config.py)
